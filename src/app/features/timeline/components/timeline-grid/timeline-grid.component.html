<section class="timeline-grid" tabindex="0" (focus)="onGridFocus()" (click)="onGridClick($event)">
  <div class="grid-wrapper">
    <!-- Left fixed column -->
    <div class="left-panel" [class.first-column-selected]="selectedColumnIndex === 0">
      <div class="work-center-label-header">
        <span class="work-center-label-text">Work Center</span>
      </div>
      <div class="left-panel-body">
        @for (center of cachedWorkCenters; track center.id) {
          <div class="work-center-label"
            [class.active]="activeWorkCenterId === center.id"
            [class.hover]="hoveredCenterId() === center.id"
            (mouseenter)="hoveredCenterId.set(center.id)"
            (mouseleave)="hoveredCenterId.set(null)">{{ center.name }}
          </div>
        }
      </div>
    </div>

    <!-- Right scrollable area (single scroll for header + all rows) -->
    <div class="right-panel" #rightPanel (scroll)="onHeaderScroll($event)">
      <!-- Date columns header -->
      <div class="date-columns-header" [style.width.px]="totalGridWidth">
        @for (col of dateColumns; track col.date.getTime(); let i = $index) {
          <div class="date-column-header"
            [style.width.px]="col.width" (click)="onDateColumnClick(col)" [class.selected]="i === selectedColumnIndex">
            <span class="column-label">{{ col.label }}</span>
          </div>
        }

        <!-- Current badge overlay (absolute, inside header so it doesn't affect row heights) -->
        @if (selectedDateColumn()) {
          <div class="current-badge-overlay" [style.left.px]="cachedSelectedColumnPosition">
            <div class="current-badge">
              <span class="current-text">{{ currentLabel }}</span>
            </div>
          </div>
        }
      </div>

      <!-- Grid body rows -->
      <div class="grid-body" [style.width.px]="totalGridWidth">
        <!-- Full-height column dividers (extends to bottom of grid) -->
        <div class="column-dividers">
          @for (col of dateColumns; track col.date.getTime(); let i = $index) {
            <div class="column-divider"
              [style.width.px]="col.width" [class.selected-column]="i === selectedColumnIndex"
              [class.before-selected-column]="i === selectedColumnIndex - 1"></div>
          }
        </div>

        <!-- Current day indicator - full height, behind work-order-bars -->
        <app-current-day-indicator [gridStartDate]="gridStartDate"></app-current-day-indicator>

        @for (center of cachedWorkCenters; track center.id; let first = $first) {
          <div class="work-center-row"
            [class.active]="activeWorkCenterId === center.id"
            [class.hover]="hoveredCenterId() === center.id"
            (mouseenter)="hoveredCenterId.set(center.id)"
            (mouseleave)="hoveredCenterId.set(null)">
            <div class="timeline-cells-container" (mousemove)="onCellMouseMove($event, center.id, first)"
              (mouseleave)="onCellMouseLeave()" (click)="onTimelineClick($event, center.id)">
              <!-- Date column borders -->
              @for (col of dateColumns; track col.date.getTime(); let i = $index) {
                <div class="timeline-cell"
                  [style.width.px]="col.width" [class.selected-column]="i === selectedColumnIndex"
                  [class.before-selected-column]="i === selectedColumnIndex - 1"></div>
              }
            </div>

            <!-- Ghost hover tooltip and placeholder -->
            @if (hoverRowId() === center.id) {
              <div class="ghost-hover" [class.tooltip-below]="hoverIsFirstRow()"
                [style.left.px]="hoverX()">
                <div class="ghost-tooltip">Click to add dates</div>
                <div class="ghost-rect"></div>
              </div>
            }

            <!-- Work orders as absolutely positioned bars -->
            <div class="orders-overlay">
              @for (order of getOrdersForCenter(center.id); track order.docId) {
                <app-work-order-bar
                  [order]="order" [style.left.px]="getCachedBarLeft(order)" [style.width.px]="getCachedBarWidth(order)"
                  class="work-order-item" [class.focused]="isOrderFocused(order)" (mouseenter)="onCellMouseLeave()" (edit)="onEditOrder($event)"
                  (delete)="onDeleteOrder($event)">
                </app-work-order-bar>
              }
            </div>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Empty state -->
  @if (orders().length === 0) {
    <div class="empty-state">
      <p>No work orders to display</p>
    </div>
  }
</section>